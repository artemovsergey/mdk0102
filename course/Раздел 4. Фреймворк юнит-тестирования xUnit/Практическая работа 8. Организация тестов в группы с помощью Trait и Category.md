# Практическая работа 8. Организация тестов в группы с помощью Trait и Category

## **Тема**
Освоение техники организации и категоризации тестов с использованием атрибутов Trait в xUnit для эффективного управления тестовыми наборами.

## **Цель**
Научить студентов организовывать тесты в логические группы для:
- Группового выполнения тестов
- Фильтрации тестов по категориям
- Организации тестов по функциональности, приоритету, типу
- Улучшения управляемости тестового набора

## **Теоретическая часть**

**Атрибуты Trait** в xUnit позволяют добавлять метаданные к тестам для их категоризации и организации. Это особенно полезно в больших проектах с сотнями тестов.

### **Основные способы организации тестов:**

**1. Атрибут `[Trait]`**
Позволяет добавлять пары ключ-значение к тестам:

```csharp
[Trait("Category", "Unit")]
[Trait("Priority", "High")]
public class MyTests
{
    [Trait("Feature", "Authentication")]
    public void Test1() { }
}
```

**2. Предопределенные константы**
Для избежания опечаток и улучшения поддержки:

```csharp
public static class Traits
{
    public const string Category = "Category";
    public const string Priority = "Priority";
    public const string Feature = "Feature";
    
    public static class Categories
    {
        public const string Unit = "Unit";
        public const string Integration = "Integration";
        public const string System = "System";
    }
    
    public static class Priorities
    {
        public const string Critical = "Critical";
        public const string High = "High";
        public const string Medium = "Medium";
        public const string Low = "Low";
    }
}
```

### **Сценарии использования Trait:**

**1. По типу теста:**
- Unit, Integration, System, UI, API

**2. По функциональности:**
- Authentication, Payment, Reporting, Database

**3. По приоритету:**
- Critical, High, Medium, Low

**4. По стабильности:**
- Stable, Flaky, Slow, Fast

**5. По бизнес-домену:**
- UserManagement, OrderProcessing, Inventory

## **Ход работы**

1. Создайте решение с двумя проектами:
   - **Проект приложения**: `TestOrganizationDemo`
   - **Тестовый проект**: `TestOrganizationDemo.Tests`

2. Создайте классы для организации Trait-констант

3. Реализуйте тестовые классы согласно вашему варианту

4. Разметьте тесты атрибутами Trait по различным категориям

5. Настройте фильтрацию тестов в Test Explorer

6. Создайте папку `images` со скриншотами фильтрации тестов

7. Оформите README.md согласно требованиям

## **Практический пример**

**Проект приложения:**
```csharp
namespace TestOrganizationDemo
{
    public class UserService
    {
        private readonly List<User> _users = new();
        
        public void RegisterUser(string username, string email, string password)
        {
            if (string.IsNullOrWhiteSpace(username))
                throw new ArgumentException("Username cannot be empty");
                
            if (string.IsNullOrWhiteSpace(email))
                throw new ArgumentException("Email cannot be empty");
                
            if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
                throw new ArgumentException("Password must be at least 6 characters");
                
            if (_users.Any(u => u.Username == username))
                throw new InvalidOperationException("Username already exists");
                
            _users.Add(new User(username, email, password));
        }
        
        public bool Authenticate(string username, string password)
        {
            var user = _users.FirstOrDefault(u => u.Username == username);
            return user != null && user.Password == password;
        }
        
        public void ChangePassword(string username, string oldPassword, string newPassword)
        {
            var user = _users.FirstOrDefault(u => u.Username == username);
            if (user == null)
                throw new InvalidOperationException("User not found");
                
            if (user.Password != oldPassword)
                throw new InvalidOperationException("Invalid old password");
                
            if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
                throw new ArgumentException("New password must be at least 6 characters");
                
            user.Password = newPassword;
        }
    }
    
    public class PaymentProcessor
    {
        public PaymentResult ProcessPayment(PaymentInfo payment)
        {
            if (payment == null)
                throw new ArgumentNullException(nameof(payment));
                
            if (payment.Amount <= 0)
                throw new ArgumentException("Payment amount must be positive");
                
            if (string.IsNullOrWhiteSpace(payment.CardNumber))
                throw new ArgumentException("Card number is required");
                
            // Имитация обработки платежа
            return new PaymentResult
            {
                Success = true,
                TransactionId = Guid.NewGuid().ToString(),
                Message = "Payment processed successfully"
            };
        }
        
        public async Task<PaymentResult> ProcessPaymentAsync(PaymentInfo payment)
        {
            // Имитация асинхронной операции
            await Task.Delay(100);
            return ProcessPayment(payment);
        }
    }
    
    public class ReportGenerator
    {
        public string GenerateSalesReport(DateTime startDate, DateTime endDate)
        {
            if (startDate > endDate)
                throw new ArgumentException("Start date cannot be after end date");
                
            if (startDate < DateTime.Now.AddYears(-1))
                throw new ArgumentException("Cannot generate reports for dates older than 1 year");
                
            // Имитация генерации отчета
            return $"Sales report from {startDate:yyyy-MM-dd} to {endDate:yyyy-MM-dd}";
        }
        
        public byte[] GeneratePdfReport(string reportData)
        {
            if (string.IsNullOrWhiteSpace(reportData))
                throw new ArgumentException("Report data cannot be empty");
                
            // Имитация генерации PDF
            return System.Text.Encoding.UTF8.GetBytes(reportData);
        }
    }
    
    public class User
    {
        public string Username { get; set; }
        public string Email { get; set; }
        public string Password { get; set; }
        
        public User(string username, string email, string password)
        {
            Username = username;
            Email = email;
            Password = password;
        }
    }
    
    public class PaymentInfo
    {
        public decimal Amount { get; set; }
        public string CardNumber { get; set; }
        public string CardHolder { get; set; }
    }
    
    public class PaymentResult
    {
        public bool Success { get; set; }
        public string TransactionId { get; set; }
        public string Message { get; set; }
    }
}
```

**Класс для организации Trait-констант:**
```csharp
namespace TestOrganizationDemo.Tests
{
    public static class Traits
    {
        public const string Category = "Category";
        public const string Priority = "Priority";
        public const string Feature = "Feature";
        public const string Type = "Type";
        public const string Owner = "Owner";
        public const string Stability = "Stability";
        
        public static class Categories
        {
            public const string Unit = "Unit";
            public const string Integration = "Integration";
            public const string System = "System";
            public const string Smoke = "Smoke";
            public const string Regression = "Regression";
        }
        
        public static class Priorities
        {
            public const string Critical = "Critical";
            public const string High = "High";
            public const string Medium = "Medium";
            public const string Low = "Low";
        }
        
        public static class Features
        {
            public const string UserManagement = "UserManagement";
            public const string Payment = "Payment";
            public const string Reporting = "Reporting";
            public const string Authentication = "Authentication";
        }
        
        public static class Types
        {
            public const string Positive = "Positive";
            public const string Negative = "Negative";
            public const string Boundary = "Boundary";
            public const string Exception = "Exception";
        }
        
        public static class Stabilities
        {
            public const string Stable = "Stable";
            public const string Flaky = "Flaky";
            public const string Slow = "Slow";
            public const string Fast = "Fast";
        }
    }
}
```

**Тестовый проект:**
```csharp
using Xunit;
using TestOrganizationDemo;

namespace TestOrganizationDemo.Tests
{
    [Trait(Traits.Category, Traits.Categories.Unit)]
    [Trait(Traits.Feature, Traits.Features.UserManagement)]
    public class UserServiceTests
    {
        private readonly UserService _userService = new UserService();

        [Trait(Traits.Priority, Traits.Priorities.Critical)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Fact]
        public void RegisterUser_ValidData_UserRegisteredSuccessfully()
        {
            // Arrange
            string username = "testuser";
            string email = "test@example.com";
            string password = "password123";

            // Act
            var exception = Record.Exception(() => 
                _userService.RegisterUser(username, email, password));

            // Assert
            Assert.Null(exception);
        }

        [Trait(Traits.Priority, Traits.Priorities.High)]
        [Trait(Traits.Type, Traits.Types.Negative)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Theory]
        [InlineData("", "test@example.com", "password123")]
        [InlineData("user", "", "password123")]
        [InlineData("user", "test@example.com", "")]
        [InlineData("user", "test@example.com", "123")]
        public void RegisterUser_InvalidData_ThrowsException(string username, string email, string password)
        {
            // Act & Assert
            Assert.Throws<ArgumentException>(() => 
                _userService.RegisterUser(username, email, password));
        }

        [Trait(Traits.Priority, Traits.Priorities.Medium)]
        [Trait(Traits.Type, Traits.Types.Exception)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Fact]
        public void RegisterUser_DuplicateUsername_ThrowsInvalidOperationException()
        {
            // Arrange
            _userService.RegisterUser("user1", "user1@example.com", "password123");

            // Act & Assert
            Assert.Throws<InvalidOperationException>(() => 
                _userService.RegisterUser("user1", "user2@example.com", "password456"));
        }

        [Trait(Traits.Priority, Traits.Priorities.High)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Feature, Traits.Features.Authentication)]
        [Fact]
        public void Authenticate_ValidCredentials_ReturnsTrue()
        {
            // Arrange
            _userService.RegisterUser("authuser", "auth@example.com", "password123");

            // Act
            bool result = _userService.Authenticate("authuser", "password123");

            // Assert
            Assert.True(result);
        }

        [Trait(Traits.Priority, Traits.Priorities.Medium)]
        [Trait(Traits.Type, Traits.Types.Negative)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Fact]
        public void Authenticate_InvalidCredentials_ReturnsFalse()
        {
            // Arrange
            _userService.RegisterUser("authuser2", "auth2@example.com", "password123");

            // Act
            bool result = _userService.Authenticate("authuser2", "wrongpassword");

            // Assert
            Assert.False(result);
        }
    }

    [Trait(Traits.Category, Traits.Categories.Unit)]
    [Trait(Traits.Feature, Traits.Features.Payment)]
    public class PaymentProcessorTests
    {
        private readonly PaymentProcessor _paymentProcessor = new PaymentProcessor();

        [Trait(Traits.Priority, Traits.Priorities.Critical)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Fact]
        public void ProcessPayment_ValidPayment_ReturnsSuccessResult()
        {
            // Arrange
            var payment = new PaymentInfo
            {
                Amount = 100.50m,
                CardNumber = "4111111111111111",
                CardHolder = "John Doe"
            };

            // Act
            var result = _paymentProcessor.ProcessPayment(payment);

            // Assert
            Assert.True(result.Success);
            Assert.NotNull(result.TransactionId);
            Assert.Contains("successfully", result.Message);
        }

        [Trait(Traits.Priority, Traits.Priorities.High)]
        [Trait(Traits.Type, Traits.Types.Exception)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Theory]
        [InlineData(0)]
        [InlineData(-100)]
        public void ProcessPayment_InvalidAmount_ThrowsException(decimal amount)
        {
            // Arrange
            var payment = new PaymentInfo
            {
                Amount = amount,
                CardNumber = "4111111111111111"
            };

            // Act & Assert
            Assert.Throws<ArgumentException>(() => _paymentProcessor.ProcessPayment(payment));
        }

        [Trait(Traits.Priority, Traits.Priorities.Medium)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Stability, Traits.Stabilities.Slow)]
        [Fact]
        public async Task ProcessPaymentAsync_ValidPayment_ReturnsSuccessResult()
        {
            // Arrange
            var payment = new PaymentInfo
            {
                Amount = 50.00m,
                CardNumber = "4111111111111111"
            };

            // Act
            var result = await _paymentProcessor.ProcessPaymentAsync(payment);

            // Assert
            Assert.True(result.Success);
        }
    }

    [Trait(Traits.Category, Traits.Categories.Integration)]
    [Trait(Traits.Feature, Traits.Features.Reporting)]
    public class ReportGeneratorTests
    {
        private readonly ReportGenerator _reportGenerator = new ReportGenerator();

        [Trait(Traits.Priority, Traits.Priorities.Medium)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Stability, Traits.Stabilities.Slow)]
        [Fact]
        public void GenerateSalesReport_ValidDates_ReturnsReport()
        {
            // Arrange
            var startDate = DateTime.Now.AddDays(-30);
            var endDate = DateTime.Now;

            // Act
            var report = _reportGenerator.GenerateSalesReport(startDate, endDate);

            // Assert
            Assert.NotNull(report);
            Assert.Contains(startDate.ToString("yyyy-MM-dd"), report);
        }

        [Trait(Traits.Priority, Traits.Priorities.Low)]
        [Trait(Traits.Type, Traits.Types.Boundary)]
        [Trait(Traits.Stability, Traits.Stabilities.Flaky)]
        [Fact]
        public void GenerateSalesReport_StartDateAfterEndDate_ThrowsException()
        {
            // Arrange
            var startDate = DateTime.Now;
            var endDate = DateTime.Now.AddDays(-1);

            // Act & Assert
            Assert.Throws<ArgumentException>(() => 
                _reportGenerator.GenerateSalesReport(startDate, endDate));
        }

        [Trait(Traits.Priority, Traits.Priorities.High)]
        [Trait(Traits.Type, Traits.Types.Positive)]
        [Trait(Traits.Stability, Traits.Stabilities.Fast)]
        [Fact]
        public void GeneratePdfReport_ValidData_ReturnsBytes()
        {
            // Arrange
            string reportData = "Test report content";

            // Act
            var pdfBytes = _reportGenerator.GeneratePdfReport(reportData);

            // Assert
            Assert.NotNull(pdfBytes);
            Assert.NotEmpty(pdfBytes);
        }
    }

    // Smoke тесты - быстрая проверка основных функций
    [Trait(Traits.Category, Traits.Categories.Smoke)]
    public class SmokeTests
    {
        [Trait(Traits.Priority, Traits.Priorities.Critical)]
        [Trait(Traits.Feature, Traits.Features.UserManagement)]
        [Trait(Traits.Stability, Traits.Stabilities.Fast)]
        [Fact]
        public void Smoke_UserRegistration_ShouldWork()
        {
            // Arrange
            var userService = new UserService();

            // Act & Assert
            var exception = Record.Exception(() => 
                userService.RegisterUser("smokeuser", "smoke@test.com", "password123"));

            Assert.Null(exception);
        }

        [Trait(Traits.Priority, Traits.Priorities.Critical)]
        [Trait(Traits.Feature, Traits.Features.Payment)]
        [Trait(Traits.Stability, Traits.Stabilities.Fast)]
        [Fact]
        public void Smoke_PaymentProcessing_ShouldWork()
        {
            // Arrange
            var paymentProcessor = new PaymentProcessor();
            var payment = new PaymentInfo
            {
                Amount = 1.00m,
                CardNumber = "4111111111111111"
            };

            // Act & Assert
            var exception = Record.Exception(() => 
                paymentProcessor.ProcessPayment(payment));

            Assert.Null(exception);
        }
    }

    // Регрессионные тесты
    [Trait(Traits.Category, Traits.Categories.Regression)]
    public class RegressionTests
    {
        [Trait(Traits.Priority, Traits.Priorities.High)]
        [Trait(Traits.Feature, Traits.Features.UserManagement)]
        [Trait(Traits.Stability, Traits.Stabilities.Stable)]
        [Fact]
        public void Regression_ChangePassword_OldScenario()
        {
            // Arrange
            var userService = new UserService();
            userService.RegisterUser("reguser", "reg@test.com", "oldpassword");

            // Act & Assert
            var exception = Record.Exception(() => 
                userService.ChangePassword("reguser", "oldpassword", "newpassword123"));

            Assert.Null(exception);
        }
    }
}
```

---

## **Варианты заданий**

**Вариант 1:** Система управления заказами (OrderManagement)
- Тесты для создания, обновления, отмены заказов
- Категории: Unit, Integration, Smoke, Regression
- Приоритеты: Critical, High, Medium

**Вариант 2:** Инвентарная система (InventorySystem)
- Тесты для добавления, удаления, резервирования товаров
- Фичи: StockManagement, Reservations, Reporting
- Типы: Positive, Negative, Boundary

**Вариант 3:** Система аутентификации (AuthSystem)
- Тесты для регистрации, логина, смены пароля
- Стабильность: Stable, Flaky
- Категории: Unit, Integration, Security

**Вариант 4:** Платежная шлюза (PaymentGateway)
- Тесты для обработки платежей, возвратов, верификации
- Приоритеты: Critical, High
- Типы: Positive, Exception, Boundary

**Вариант 5:** Генератор отчетов (ReportingEngine)
- Тесты для генерации различных форматов отчетов
- Стабильность: Slow, Fast, Flaky
- Категории: Unit, Integration, Performance

**Вариант 6:** Кэширующая система (CachingSystem)
- Тесты для добавления, получения, инвалидации кэша
- Фичи: MemoryCache, DistributedCache, Invalidation
- Типы: Positive, Negative, Performance

**Вариант 7:** Сервис уведомлений (NotificationService)
- Тесты для email, SMS, push-уведомлений
- Категории: Unit, Integration, External
- Приоритеты: High, Medium, Low

**Вариант 8:** Валидатор данных (DataValidator)
- Тесты для валидации различных форматов данных
- Типы: Positive, Negative, Boundary, Format
- Стабильность: Stable, Fast

**Вариант 9:** API клиент (ApiClient)
- Тесты для HTTP запросов, сериализации, ошибок
- Категории: Unit, Integration, Network
- Приоритеты: Critical, High

**Вариант 10:** Система кворумов (QuorumSystem)
- Тесты для распределенных вычислений, консенсуса
- Стабильность: Flaky, Slow
- Категории: Integration, System, Distributed

**Вариант 11:** Очередь сообщений (MessageQueue)
- Тесты для отправки, получения, обработки сообщений
- Фичи: QueueManagement, MessageProcessing, DLQ
- Типы: Positive, Negative, Performance

**Вариант 12:** Геосервис (GeoService)
- Тесты для расчета расстояний, геокодирования
- Категории: Unit, Integration, External
- Приоритеты: Medium, Low

**Вариант 13:** Шифровальщик (EncryptionService)
- Тесты для шифрования, дешифрования, хэширования
- Категории: Unit, Security
- Стабильность: Stable, Fast

**Вариант 14:** Планировщик задач (TaskScheduler)
- Тесты для планирования, выполнения, отмены задач
- Типы: Positive, Negative, Timing
- Приоритеты: High, Medium

**Вариант 15:** Анализатор логов (LogAnalyzer)
- Тесты для парсинга, фильтрации, анализа логов
- Категории: Unit, Integration, FileIO
- Стабильность: Stable, Slow

---

## **Критерии оценки**

**5 (Отлично):**
- Создан класс для организации Trait-констант
- Тесты разбиты на минимум 5 различных категорий
- Использованы все основные типы Trait (Category, Priority, Feature, Type, Stability)
- Созданы отдельные классы для Smoke и Regression тестов
- Написано минимум 15 тестов с различными комбинациями Trait
- Сделаны скриншоты фильтрации тестов в Test Explorer

**4 (Хорошо):**
- Создан класс для Trait-констант
- Тесты разбиты на 3-4 категории
- Использованы основные типы Trait
- Написано 10-14 тестов с Trait
- Есть скриншоты фильтрации

**3 (Удовлетворительно):**
- Использованы базовые Trait атрибуты
- Тесты разбиты на 2 категории
- Написано 8-9 тестов с Trait
- Нет скриншотов или они неполные

**2 (Неудовлетворительно):**
- Trait атрибуты не использованы
- Менее 8 тестов
- Нет организации тестов

---

## **Контрольные вопросы**

1. Какие преимущества дает использование атрибутов Trait?
2. Как организовать константы для Trait чтобы избежать опечаток?
3. Какие критерии можно использовать для категоризации тестов?
4. Как выполнить только тесты определенной категории в Test Explorer?
5. В чем разница между Category и Feature в контексте Trait?
6. Как организовать тесты для Smoke и Regression testing?
7. Какие лучшие практики по организации большого количества тестов?

---

## **Пример README.md для варианта 1**

```markdown
# Практическая работа: Организация тестов в группы с помощью Trait и Category

**Вариант: 1**

**Задание:**
Реализовать систему управления заказами и организовать тесты с помощью атрибутов Trait по категориям:
- Category: Unit, Integration, Smoke, Regression
- Priority: Critical, High, Medium, Low  
- Feature: OrderCreation, OrderUpdate, OrderCancellation
- Type: Positive, Negative, Boundary, Exception
- Stability: Stable, Flaky, Slow, Fast

**Код организации Trait:**

```csharp
// TestOrganizationDemo.Tests/Traits.cs
public static class Traits
{
    public const string Category = "Category";
    public const string Priority = "Priority";
    public const string Feature = "Feature";
    public const string Type = "Type";
    public const string Stability = "Stability";
    
    public static class Categories
    {
        public const string Unit = "Unit";
        public const string Integration = "Integration";
        public const string Smoke = "Smoke";
        public const string Regression = "Regression";
    }
    
    public static class Priorities
    {
        public const string Critical = "Critical";
        public const string High = "High";
        public const string Medium = "Medium";
        public const string Low = "Low";
    }
    
    public static class Features
    {
        public const string OrderCreation = "OrderCreation";
        public const string OrderUpdate = "OrderUpdate";
        public const string OrderCancellation = "OrderCancellation";
    }
    
    public static class Types
    {
        public const string Positive = "Positive";
        public const string Negative = "Negative";
        public const string Boundary = "Boundary";
        public const string Exception = "Exception";
    }
    
    public static class Stabilities
    {
        public const string Stable = "Stable";
        public const string Flaky = "Flaky";
        public const string Slow = "Slow";
        public const string Fast = "Fast";
    }
}
```

**Пример тестов с Trait:**

```csharp
// TestOrganizationDemo.Tests/OrderServiceTests.cs
[Trait(Traits.Category, Traits.Categories.Unit)]
[Trait(Traits.Feature, Traits.Features.OrderCreation)]
public class OrderServiceTests
{
    [Trait(Traits.Priority, Traits.Priorities.Critical)]
    [Trait(Traits.Type, Traits.Types.Positive)]
    [Trait(Traits.Stability, Traits.Stabilities.Stable)]
    [Fact]
    public void CreateOrder_ValidData_OrderCreatedSuccessfully()
    {
        // Тест создания заказа
    }

    [Trait(Traits.Priority, Traits.Priorities.High)]
    [Trait(Traits.Type, Traits.Types.Negative)]
    [Trait(Traits.Stability, Traits.Stabilities.Stable)]
    [Fact]
    public void CreateOrder_InvalidProduct_ThrowsException()
    {
        // Тест обработки ошибок
    }
}

[Trait(Traits.Category, Traits.Categories.Smoke)]
public class SmokeTests
{
    [Trait(Traits.Priority, Traits.Priorities.Critical)]
    [Trait(Traits.Feature, Traits.Features.OrderCreation)]
    [Fact]
    public void Smoke_OrderCreation_ShouldWork()
    {
        // Smoke тест
    }
}
```

**Скриншоты фильтрации тестов:**

1. Фильтр по Category:Unit
![Фильтр по Unit тестам](images/unit_tests_filter.png)

2. Фильтр по Priority:Critical  
![Фильтр по Critical тестам](images/critical_tests_filter.png)

3. Фильтр по Feature:OrderCreation
![Фильтр по OrderCreation](images/order_creation_filter.png)
```

**Результат выполнения тестов:**
![Скриншот тестов](images/test_results.png)
```