# Лекция 18. Ожидания в Selenium (Implicit, Explicit, Fluent)

## Цель лекции

Научить студентов использовать различные типы ожиданий в Selenium WebDriver для стабильной и надежной автоматизации тестирования веб-приложений.

---

## План лекции

1. Введение в ожидания в Selenium
2. Implicit Wait (неявное ожидание)
3. Explicit Wait (явное ожидание)
4. Fluent Wait (гибкое ожидание)
5. Сравнение типов ожиданий и рекомендации
6. Примеры практического использования
7. Резюме
8. Контрольные вопросы

---

## 1. Введение в ожидания в Selenium

**Проблема:**
Веб-элементы на страницах могут загружаться с задержкой. Если WebDriver сразу пытается найти элемент, тест падает с ошибкой `NoSuchElementException`.

**Решение:**
Использовать **ожидания (Waits)** — это механизмы, которые заставляют WebDriver ждать появления элементов перед взаимодействием.

В Selenium существуют три основных типа ожиданий:

* **Implicit Wait** – глобальное ожидание для всех элементов
* **Explicit Wait** – ожидание конкретного элемента с заданным условием
* **Fluent Wait** – расширенная версия Explicit Wait с возможностью задать частоту опроса и игнорируемые исключения

---

## 2. Implicit Wait (неявное ожидание)

* Глобальное ожидание для поиска всех элементов
* Если элемент не найден, WebDriver будет пробовать искать его **в течение заданного времени**

**Пример кода на C#:**

```csharp
IWebDriver driver = new ChromeDriver();
driver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);

driver.Navigate().GoToUrl("https://example.com");
IWebElement username = driver.FindElement(By.Id("username")); // WebDriver будет ждать до 10 секунд
```

**Особенности:**

* Задается один раз для всего WebDriver
* Удобно для страниц с небольшими задержками
* Не подходит для сложных условий (например, ждать, пока элемент станет кликабельным)

---

## 3. Explicit Wait (явное ожидание)

* Ожидание конкретного элемента с определенным условием
* Используется класс `WebDriverWait`
* Условие задается через `ExpectedConditions`

**Пример кода:**

```csharp
using OpenQA.Selenium.Support.UI;
using SeleniumExtras.WaitHelpers;

IWebDriver driver = new ChromeDriver();
driver.Navigate().GoToUrl("https://example.com/login");

WebDriverWait wait = new WebDriverWait(driver, TimeSpan.FromSeconds(10));
IWebElement loginButton = wait.Until(ExpectedConditions.ElementToBeClickable(By.Id("loginBtn")));

loginButton.Click();
```

**Примеры условий для Explicit Wait:**

* `ElementToBeClickable` – элемент доступен для клика
* `VisibilityOfAllElementsLocatedBy` – элементы видимы на странице
* `ElementExists` – элемент присутствует в DOM
* `TextToBePresentInElement` – текст появился в элементе

---

## 4. Fluent Wait (гибкое ожидание)

* Расширение Explicit Wait
* Позволяет задавать:

  * Время ожидания
  * Частоту опроса (polling interval)
  * Исключения, которые игнорируются

**Пример кода:**

```csharp
using OpenQA.Selenium.Support.UI;
using SeleniumExtras.WaitHelpers;

IWebDriver driver = new ChromeDriver();
driver.Navigate().GoToUrl("https://example.com/login");

DefaultWait<IWebDriver> fluentWait = new DefaultWait<IWebDriver>(driver);
fluentWait.Timeout = TimeSpan.FromSeconds(15);          // Максимальное время ожидания
fluentWait.PollingInterval = TimeSpan.FromSeconds(1);   // Частота опроса
fluentWait.IgnoreExceptionTypes(typeof(NoSuchElementException));

IWebElement username = fluentWait.Until(d => d.FindElement(By.Id("username")));
username.SendKeys("testuser");
```

**Особенности Fluent Wait:**

* Удобно для динамических страниц с непредсказуемой загрузкой элементов
* Позволяет игнорировать исключения
* Позволяет задавать кастомные функции проверки

---

## 5. Сравнение типов ожиданий

| Тип ожидания  | Уровень    | Когда использовать                                                |
| ------------- | ---------- | ----------------------------------------------------------------- |
| Implicit Wait | Глобальный | Простые страницы с небольшой задержкой элементов                  |
| Explicit Wait | Локальный  | Элементы, появление которых зависит от действий или AJAX          |
| Fluent Wait   | Локальный  | Динамические элементы с нестабильной загрузкой, кастомные условия |

**Рекомендации:**

* Не смешивать Implicit и Explicit, чтобы избежать неожиданных задержек
* Для сложных динамических страниц использовать Explicit или Fluent Wait
* Всегда использовать ожидания перед взаимодействием с элементами

---

## 6. Примеры практического использования

### Пример 1: Ожидание кликабельного элемента (Explicit Wait)

```csharp
WebDriverWait wait = new WebDriverWait(driver, TimeSpan.FromSeconds(10));
IWebElement submit = wait.Until(ExpectedConditions.ElementToBeClickable(By.Id("submitBtn")));
submit.Click();
```

### Пример 2: Fluent Wait с игнорированием исключений

```csharp
DefaultWait<IWebDriver> fluentWait = new DefaultWait<IWebDriver>(driver);
fluentWait.Timeout = TimeSpan.FromSeconds(20);
fluentWait.PollingInterval = TimeSpan.FromSeconds(2);
fluentWait.IgnoreExceptionTypes(typeof(NoSuchElementException));

IWebElement dynamicElement = fluentWait.Until(d => d.FindElement(By.Id("dynamic")));
dynamicElement.Click();
```

---

## 7. Резюме

* Ожидания необходимы для стабильной работы тестов
* **Implicit Wait** – глобальное ожидание, простой случай
* **Explicit Wait** – локальное ожидание конкретного элемента с условием
* **Fluent Wait** – расширенный вариант Explicit Wait с кастомизацией времени опроса и игнорируемых исключений
* Использование ожиданий делает тесты устойчивыми к задержкам и динамическому контенту

---

## 8. Контрольные вопросы

1. Зачем нужны ожидания в Selenium WebDriver?
2. В чем разница между Implicit и Explicit Wait?
3. Какие условия можно использовать с Explicit Wait?
4. Что такое Fluent Wait и чем он отличается от Explicit Wait?
5. Можно ли комбинировать Implicit и Explicit Wait? Почему или почему нет?
6. Приведите пример использования Fluent Wait для динамического элемента.
7. Как выбрать тип ожидания для страницы с AJAX-загрузкой элементов?
