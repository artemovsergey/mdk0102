# Лекция 22. Библиотека RestSharp для автоматизации тестирования API

Библиотека RestSharp: создание API-клиента и выполнение запросов в автоматизированных тестах

---

### **План лекции:**

1.  **Введение в RestSharp**
    *   Что такое RestSharp и зачем он нужен тестировщику?
    *   Сравнение с HttpClient и другими подходами.
    *   Установка и настройка в проекте.

2.  **Базовые понятия RestSharp**
    *   RestClient - основной клиент.
    *   RestRequest - настройка запроса.
    *   RestResponse - работа с ответом.

3.  **Создание и настройка API-клиента**
    *   Базовый URL и таймауты.
    *   Настройка сериализации JSON.
    *   Добавление общих заголовков.

4.  **Формирование и выполнение запросов**
    *   HTTP-методы (GET, POST, PUT, DELETE).
    *   Добавление параметров: путь (URL Segment), query string, body.
    *   Работа с заголовками и аутентификацией.
    *   Отправка данных в формате JSON.

5.  **Обработка и валидация ответов**
    *   Анализ кода состояния.
    *   Извлечение данных из тела ответа.
    *   Обработка ошибок и исключений.
    *   Валидация в автоматизированных тестах.

6.  **Практические примеры и лучшие практики**
    *   Полный пример теста для REST API.
    *   Паттерны для создания переиспользуемого клиента.
    *   Отладка запросов.

7.  **Резюме**
8.  **Контрольные вопросы**

---

### **Подробное содержание лекции по пунктам плана**

#### **1. Введение в RestSharp**

**Что такое RestSharp и зачем он нужен тестировщику?**
RestSharp — это популярная .NET библиотека для работы с REST API, которая значительно упрощает процесс отправки HTTP-запросов и обработки ответов по сравнению с использованием "голого" HttpClient.

**Преимущества для тестировщика:**
*   **Простота использования:** Интуитивно понятный fluent-интерфейс.
*   **Автоматическая сериализация:** Преобразование C# объектов в JSON и обратно "из коробки".
*   **Удобная работа с ответами:** Легкий доступ к статус-коду, заголовкам и данным ответа.
*   **Поддержка аутентификации:** Basic, OAuth, JWT и другие типы.
*   **Расширяемость:** Возможность кастомизации сериализации и десериализации.

**Сравнение с HttpClient:**
| Характеристика | HttpClient | RestSharp |
| :--- | :--- | :--- |
| **Сложность** | Больше boilerplate кода | Минимум служебного кода |
| **Сериализация** | Ручная работа с JsonSerializer | Автоматическая |
| **Читаемость** | Код разрозненный | Fluent-синтаксис, понятная цепочка вызовов |
| **Подход** | Инструмент низкого уровня | Высокоуровневая абстракция для API |

**Установка и настройка:**
```bash
# Через Package Manager Console
Install-Package RestSharp

# Через .NET CLI
dotnet add package RestSharp
```

---

#### **2. Базовые понятия RestSharp**

**RestClient** - основной класс для работы с API:
```csharp
// Базовый клиент с указанием базового URL
var client = new RestClient("https://api.example.com");
```

**RestRequest** - представляет собой HTTP-запрос:
```csharp
// Создание запроса к конкретному эндпоинту
var request = new RestRequest("users/1");
```

**RestResponse** - содержит всю информацию об ответе:
```csharp
// Выполнение запроса и получение ответа
RestResponse response = await client.GetAsync(request);

// Анализ ответа
Console.WriteLine(response.StatusCode);
Console.WriteLine(response.Content);
```

---

#### **3. Создание и настройка API-клиента**

**Базовый URL и настройки:**
```csharp
var options = new RestClientOptions("https://api.example.com")
{
    MaxTimeout = 30000, // 30 секунд
    ThrowOnAnyError = true // Бросать исключения при ошибках
};

var client = new RestClient(options);
```

**Настройка сериализации JSON:**
```csharp
var options = new RestClientOptions("https://api.example.com")
{
    ConfigureSerialization = s => s.UseSystemTextJson()
};
// или использовать Newtonsoft.Json
// ConfigureSerialization = s => s.UseSerializer(() => new JsonNetSerializer())
```

**Добавление общих заголовков:**
```csharp
var client = new RestClient("https://api.example.com");
client.AddDefaultHeader("User-Agent", "My-Test-Client");
client.AddDefaultHeader("Accept", "application/json");
```

---

#### **4. Формирование и выполнение запросов**

**HTTP-методы:**
```csharp
// GET запрос
var request = new RestRequest("users")
    .AddQueryParameter("page", "1")
    .AddQueryParameter("limit", "10");

// POST запрос
var postRequest = new RestRequest("users", Method.Post);

// PUT запрос  
var putRequest = new RestRequest("users/1", Method.Put);

// DELETE запрос
var deleteRequest = new RestRequest("users/1", Method.Delete);
```

**Добавление параметров:**

*Параметры пути (URL Segment):*
```csharp
var request = new RestRequest("users/{id}")
    .AddUrlSegment("id", 123);
// Результат: GET /users/123
```

*Query параметры:*
```csharp
var request = new RestRequest("search")
    .AddQueryParameter("q", "test")
    .AddQueryParameter("type", "user");
// Результат: GET /search?q=test&type=user
```

*Тело запроса (JSON):*
```csharp
var user = new { Name = "John", Email = "john@test.com" };
var request = new RestRequest("users", Method.Post)
    .AddJsonBody(user);
```

**Работа с заголовками и аутентификацией:**
```csharp
// Добавление заголовков
var request = new RestRequest("protected")
    .AddHeader("Authorization", "Bearer your-token-here")
    .AddHeader("X-Custom-Header", "custom-value");

// Базовая аутентификация
var client = new RestClient("https://api.example.com")
{
    Authenticator = new HttpBasicAuthenticator("username", "password")
};
```

---

#### **5. Обработка и валидация ответов**

**Анализ ответа:**
```csharp
RestResponse response = await client.ExecuteAsync(request);

// Проверка статус-кода
if (response.IsSuccessful)
{
    Console.WriteLine("Запрос выполнен успешно!");
    Console.WriteLine($"Статус: {response.StatusCode}");
    Console.WriteLine($"Тело: {response.Content}");
}
else
{
    Console.WriteLine($"Ошибка: {response.StatusCode}");
    Console.WriteLine($"Сообщение: {response.ErrorMessage}");
    Console.WriteLine($"Исключение: {response.ErrorException}");
}
```

**Извлечение типизированных данных:**
```csharp
// Для типизированного ответа используйте ExecuteAsync<T>
public class User
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

// Получение типизированного ответа
RestResponse<User> response = await client.ExecuteAsync<User>(request);

if (response.IsSuccessful)
{
    User user = response.Data;
    Console.WriteLine($"User: {user.Name}, Email: {user.Email}");
}
```

**Валидация в автоматизированных тестах (NUnit/xUnit):**
```csharp
[Test]
public async Task GetUser_ValidId_ReturnsUserData()
{
    // Arrange
    var client = new RestClient("https://jsonplaceholder.typicode.com");
    var request = new RestRequest("users/1");

    // Act
    RestResponse<User> response = await client.ExecuteAsync<User>(request);

    // Assert
    Assert.That(response.IsSuccessful, Is.True);
    Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.OK));
    Assert.That(response.Data, Is.Not.Null);
    Assert.That(response.Data.Name, Is.EqualTo("Leanne Graham"));
    Assert.That(response.Data.Email, Is.EqualTo("Sincere@april.biz"));
}
```

---

#### **6. Практические примеры и лучшие практики**

**Полный пример теста для REST API:**
```csharp
[TestFixture]
public class UserApiTests
{
    private RestClient _client;

    [SetUp]
    public void Setup()
    {
        _client = new RestClient("https://jsonplaceholder.typicode.com");
    }

    [Test]
    public async Task CreateUser_ValidData_ReturnsCreatedUser()
    {
        // Arrange
        var newUser = new { name = "Test User", email = "test@example.com" };
        var request = new RestRequest("users", Method.Post)
            .AddJsonBody(newUser);

        // Act
        RestResponse response = await _client.ExecuteAsync(request);

        // Assert
        Assert.That(response.IsSuccessful, Is.True);
        Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.Created));
        
        // Десериализация для дополнительных проверок
        var createdUser = JsonSerializer.Deserialize<User>(response.Content);
        Assert.That(createdUser.Name, Is.EqualTo("Test User"));
    }

    [Test]
    public async Task GetUser_InvalidId_ReturnsNotFound()
    {
        // Arrange
        var request = new RestRequest("users/9999");

        // Act
        RestResponse response = await _client.ExecuteAsync(request);

        // Assert
        Assert.That(response.IsSuccessful, Is.False);
        Assert.That(response.StatusCode, Is.EqualTo(HttpStatusCode.NotFound));
    }
}
```

**Паттерн для переиспользуемого клиента:**
```csharp
public class ApiClient
{
    private readonly RestClient _client;

    public ApiClient(string baseUrl)
    {
        var options = new RestClientOptions(baseUrl)
        {
            MaxTimeout = 30000,
            ThrowOnAnyError = false
        };
        _client = new RestClient(options);
    }

    public async Task<T> GetAsync<T>(string endpoint, Dictionary<string, string> parameters = null)
    {
        var request = new RestRequest(endpoint);
        
        if (parameters != null)
        {
            foreach (var param in parameters)
            {
                request.AddQueryParameter(param.Key, param.Value);
            }
        }

        var response = await _client.ExecuteAsync<T>(request);
        
        if (!response.IsSuccessful)
        {
            throw new HttpRequestException($"API request failed: {response.StatusCode} - {response.ErrorMessage}");
        }

        return response.Data;
    }

    public async Task<T> PostAsync<T>(string endpoint, object data)
    {
        var request = new RestRequest(endpoint, Method.Post)
            .AddJsonBody(data);

        var response = await _client.ExecuteAsync<T>(request);
        
        if (!response.IsSuccessful)
        {
            throw new HttpRequestException($"API request failed: {response.StatusCode} - {response.ErrorMessage}");
        }

        return response.Data;
    }
}
```

**Отладка запросов:**
```csharp
// Включение логирования
_client = new RestClient(options);
// В обработчиках событий или через ILogger

// Ручная отладка через Console
var request = new RestRequest("users")
    .AddQueryParameter("debug", "true");

var response = await _client.ExecuteAsync(request);
Console.WriteLine($"Request URL: {response.ResponseUri}");
Console.WriteLine($"Status Code: {response.StatusCode}");
Console.WriteLine($"Response: {response.Content}");
```

---

### **7. Резюме**

1.  **RestSharp** — мощная библиотека, которая значительно упрощает работу с HTTP-запросами в C#.
2.  **Основные компоненты:** RestClient (клиент), RestRequest (запрос), RestResponse (ответ).
3.  **Fluent-интерфейс** делает код читаемым и простым для понимания.
4.  **Автоматическая сериализация/десериализация** избавляет от рутинной работы с JSON.
5.  **Идеален для тестирования API** — позволяет легко создавать сложные запросы и проверять ответы.
6.  **Лучшие практики:** создание переиспользуемых клиентов, правильная обработка ошибок, использование типизированных ответов.

---

### **8. Контрольные вопросы**

1.  В чем основные преимущества RestSharp перед использованием HttpClient для тестирования API?
2.  Как создать POST-запрос с JSON телом используя RestSharp?
3.  Какая разница между AddUrlSegment и AddQueryParameter? Приведите примеры использования каждого.
4.  Как правильно обработать ответ от API и проверить, что запрос выполнен успешно?
5.  Что такое типизированный ответ (ExecuteAsync<T>) и какие преимущества он дает?
6.  Как добавить аутентификацию Bearer Token к запросу в RestSharp?
7.  Напишите пример теста, который проверяет создание пользователя и последующее получение его данных.
8.  Какие настройки RestClientOptions вы считаете наиболее важными для стабильной работы тестов?