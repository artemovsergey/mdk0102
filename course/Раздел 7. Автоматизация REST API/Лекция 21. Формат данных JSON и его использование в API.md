# Лекция 21. Формат данных JSON и его использование в API

### **Тема лекции:** JSON — язык данных для веба. Синтаксис, валидация и применение в тестировании REST API

---

### **План лекции:**

1.  **Введение в JSON. Зачем он нужен?**
    *   Проблема обмена данными до JSON.
    *   Что такое JSON? Его преимущества.
    *   Сравнение с XML (кратко).

2.  **Синтаксис JSON: От простого к сложному**
    *   Структура: Пары "ключ-значение".
    *   Типы данных: string, number, boolean, null, object, array.
    *   Примеры корректного и некорректного синтаксиса.

3.  **JSON в работе REST API**
    *   Тело HTTP-запроса (Request Body).
    *   Тело HTTP-ответа (Response Body).
    *   Практические примеры для CRUD-операций.

4.  **Валидация JSON: Глаз тестировщика**
    *   Что такое JSON Schema?
    *   Зачем она нужна тестировщику?
    *   Практический пример валидации ответа API по схеме.

5.  **Инструменты тестировщика для работы с JSON**
    *   Валидаторы и "красивости" (форматтеры).
    *   Генераторы данных на основе JSON Schema.
    *   Работа с JSON в Postman и автоматизированных тестах (C#).

6.  **Резюме**
7.  **Контрольные вопросы**

---

### **Подробное содержание лекции по пунктам плана**

#### **1. Введение в JSON. Зачем он нужен?**

**Проблема обмена данными до JSON:**
Раньше для обмена данными между клиентом и сервером широко использовался XML. Он мощный, но очень многословный.

*Пример XML для пользователя:*
```xml
<user>
    <id>1</id>
    <name>John Doe</name>
    <email>john.doe@example.com</email>
    <isActive>true</isActive>
</user>
```
Много лишних символов (`<`, `>`, закрывающих тегов). Для компьютера это не проблема, но человеку читать неудобно, а главное — такой формат "тяжелый" для передачи по сети.

**Что такое JSON?**
JSON (JavaScript Object Notation) — это простой и легкий текстовый формат для обмена данными. Он легко читается и пишется людьми и легко парсится и генерируется компьютерами.

*Тот же пример в JSON:*
```json
{
    "id": 1,
    "name": "John Doe",
    "email": "john.doe@example.com",
    "isActive": true
}
```
Код стал короче и нагляднее.

**Преимущества JSON:**
*   **Лёгкий:** Минимум служебных символов.
*   **Читаемый:** Структура понятна с первого взгляда.
*   **Универсальный:** Поддерживается всеми современными языками программирования (C#, Java, Python, JavaScript, Go и т.д.).
*   **Идеален для API:** Является де-факто стандартом для данных в REST API.

**Сравнение с XML (кратко):**
| Характеристика | JSON | XML |
| :--- | :--- | :--- |
| **Читаемость** | Высокая | Средняя/Низкая |
| **Размер** | Компактный | "Пухлый" |
| **Парсинг** | Быстрый и простой | Медленнее и сложнее |
| **Поддержка типов**| Есть (числа, булевы) | Нет (всё — строка) |

---

#### **2. Синтаксис JSON: От простого к сложному**

**Основа — пары "ключ-значение":**
Данные хранятся в виде пар `"ключ": значение`.
*   **Ключ** — ВСЕГДА строка, заключаемая в **двойные кавычки**.
*   **Значение** — может быть разного типа.

**Типы данных в JSON:**

1.  **String (Строка):** `"name": "Anna"`
2.  **Number (Число):** `"age": 30`, `"price": 19.99`
3.  **Boolean (Логический тип):** `"isActive": true`, `"isDeleted": false`
4.  **Null (Пустое значение):** `"middleName": null`
5.  **Object (Объект):** Набор пар "ключ-значение", заключенный в `{ }`.
    ```json
    "address": {
        "street": "Lenina St.",
        "city": "Moscow",
        "zipCode": 101000
    }
    ```
6.  **Array (Массив):** Упорядоченный список значений, заключенный в `[ ]`. Значения в массиве могут быть разных типов.
    ```json
    "hobbies": ["reading", "cycling", "gaming"],
    "luckyNumbers": [7, 42, 255]
    ```

**Сложный, но реальный пример (Пользователь с заказами):**
```json
{
    "userId": 123,
    "userName": "alice_smith",
    "profile": {
        "firstName": "Alice",
        "lastName": "Smith",
        "age": 28
    },
    "roles": ["Customer", "Reviewer"],
    "isEmailVerified": true,
    "lastLogin": null,
    "orders": [
        {
            "orderId": 5001,
            "product": "Laptop",
            "price": 999.99
        },
        {
            "orderId": 5002,
            "product": "Mouse",
            "price": 25.50
        }
    ]
}
```

**Частые ошибки синтаксиса (на что смотреть тестировщику):**
*   Отсутствие двойных кавычек у ключей: `{ name: "John" }` → **НЕПРАВИЛЬНО**.
*   Использование одинарных кавычек: `{ 'name': 'John' }` → **НЕПРАВИЛЬНО** (хотя некоторые парсеры это понимают).
*   Лишняя запятая после последнего элемента:
    ```json
    {
        "a": 1,
        "b": 2, // <- эта запятая вызовет ошибку!
    }
    ```
*   Неправильный тип: `"age": "30"` (это строка, а не число).

---

#### **3. JSON в работе REST API**

JSON используется в теле HTTP-запросов и ответов.

**Тело HTTP-запроса (Request Body):**
*   **`POST /api/users`** — Создание пользователя.
    ```json
    // Запрос
    {
        "name": "Bob",
        "email": "bob@example.com",
        "password": "secure123"
    }
    ```
*   **`PUT /api/users/123`** — Полное обновление пользователя.
    ```json
    // Запрос
    {
        "name": "Bob The Great",
        "email": "bob.great@example.com",
        "password": "evenMoreSecure456"
    }
    ```
*   **`PATCH /api/users/123`** — Частичное обновление.
    ```json
    // Запрос (только меняем email)
    {
        "email": "new.email@example.com"
    }
    ```

**Тело HTTP-ответа (Response Body):**
*   **Успешный ответ (`200 OK`) на `GET /api/users/123`:**
    ```json
    // Ответ
    {
        "id": 123,
        "name": "Bob The Great",
        "email": "bob.great@example.com",
        "createdAt": "2023-10-15T14:30:00Z"
    }
    ```
*   **Ответ с ошибкой (`400 Bad Request`) на невалидный запрос:**
    ```json
    // Ответ
    {
        "type": "ValidationError",
        "title": "One or more validation errors occurred.",
        "status": 400,
        "errors": {
            "Email": ["The Email field is not a valid e-mail address."]
        }
    }
    ```
    *Такой структурированный ответ сильно помогает при отладке!*

---

#### **4. Валидация JSON: Глаз тестировщика**

**Что такое JSON Schema?**
Это сам язык описания структуры JSON-документа. Это "контракт" на данные. Схема описывает, какие поля обязательны, какие типы данных должны быть, допустимые диапазоны значений и многое другое.

**Зачем она нужна тестировщику?**
1.  **Понять требования:** Схема — это точная спецификация того, что должен возвращать API.
2.  **Автоматизировать проверки:** Вместо того чтобы вручную проверять каждое поле в ответе, можно один раз написать проверку по схеме.
3.  **Генерировать тестовые данные:** На основе схемы можно создать валидные (и невалидные) JSON-объекты для тестирования.

**Практический пример валидации:**

*   **Схема для ответа `GET /api/users/{id}`:**
    ```json
    {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "type": "object",
        "properties": {
            "id": {
                "type": "integer",
                "minimum": 1
            },
            "name": {
                "type": "string",
                "minLength": 1
            },
            "email": {
                "type": "string",
                "format": "email"
            },
            "isActive": {
                "type": "boolean"
            }
        },
        "required": ["id", "name", "email", "isActive"], // Обязательные поля!
        "additionalProperties": false // Запретить лишние поля
    }
    ```

*   **Тестирование:**
    *   *Позитивный случай:* Ответ от API полностью соответствует схеме → тест пройден.
    *   *Негативный случай:* В ответе нет поля `email` (нарушен `required`) → валидатор вернет ошибку, тест упал. Мы нашли баг.

---

#### **5. Инструменты тестировщика для работы с JSON**

1.  **Валидаторы и форматеры (красивости):**
    *   **JSONFormatter.org** (онлайн) — чтобы "причеса" нечитаемый JSON.
    *   **JSONLint.com** (онлайн) — проверка синтаксиса.
    *   Встроенные валидаторы в **Postman** и **Visual Studio Code**.

2.  **Генераторы данных:**
    *   **Mockaroo.com** — генератор реалистичных тестовых данных на основе вашей схемы.
    *   **jsonschema.net** — генерация схемы по готовому JSON.

3.  **Работа в Postman:**
    *   Вкладка **"Body"** → **"raw"** → **"JSON"**.
    *   Написание тестов на JavaScript с проверкой структуры ответа:
    ```javascript
    // Пример теста в Postman
    pm.test("Response structure is correct", function() {
        const response = pm.response.json();
        pm.expect(response).to.have.property("id");
        pm.expect(response).to.have.property("name");
        pm.expect(typeof response.id).to.eql("number");
        pm.expect(typeof response.name).to.eql("string");
    });
    ```

4.  **Работа в автоматизированных тестах (C#):**
    *   Использование библиотеки **Newtonsoft.Json** (Json.NET) или **System.Text.Json**.
    *   **Сериализация** (C# Object → JSON):
    ```csharp
    var user = new User { Name = "Tom", Age = 30 };
    string json = JsonConvert.SerializeObject(user);
    // Результат: {"Name":"Tom","Age":30}
    ```
    *   **Десериализация** (JSON → C# Object):
    ```csharp
    string jsonFromApi = "{\"Name\":\"Tom\",\"Age\":30}";
    User user = JsonConvert.DeserializeObject<User>(jsonFromApi);
    Console.WriteLine(user.Name); // Выведет "Tom"
    ```

---

### **6. Резюме**

1.  **JSON** — это простой, читаемый и легкий формат для обмена данными, ставший стандартом для REST API.
2.  **Синтаксис** основан на парах "ключ-значение" и поддерживает основные типы данных: строки, числа, булевы значения, объекты, массивы и `null`.
3.  **Как тестировщики**, мы постоянно видим JSON в телах HTTP-запросов и ответов. Мы должны уметь его читать, анализировать и находить в нем ошибки.
4.  **JSON Schema** — мощный инструмент для формального описания ожидаемой структуры данных, который позволяет автоматизировать проверки API.
5.  **Инструменты** (валидаторы, форматеры, Postman, библиотеки C#) — наши лучшие друзья в эффективной работе с JSON как при ручном, так и при автоматизированном тестировании.

---

### **7. Контрольные вопросы**

1.  Назовите три ключевых преимущества JSON перед XML.
2.  Найдите ошибки в следующем JSON-документе:
    ```json
    {
        name: "John",
        'age': 30,
        "isMarried": false,
        "hobbies": ["sports", "music",],
        "address": {
            "city": "London"
        }
    }
    ```
3.  Опишите, как будет выглядеть JSON для HTTP-запроса на создание нового поста в блоге с заголовком "Мой первый пост" и содержимым "Привет, мир!".
4.  Представьте, что вы получили от API ответ с кодом 500 и таким телом: `{ error: "Internal Server Error" }`. Что в этом ответе не так с точки зрения синтаксиса JSON? Как это исправить?
5.  Что такое JSON Schema и как она помогает в работе тестировщика?
6.  Как в Postman можно быстро проверить, что в ответе API поле `id` существует и является целым числом?